# Source-based Code Coverage

## Installation

Support for LLVM-based coverage instrumentation has been stabilized in rustc.

LVM's supplies two `tools—llvm-profdata` and `llvm-cov—that process` coverage data and generate reports.

There are several ways to find and/or install these tools, but note that the coverage mapping data generated by the Rust compiler requires LLVM version 12 or higher, and processing the raw data may require exactly the LLVM version used by the compiler. (`llvm-cov --version` typically shows the tool's LLVM version number, and `rustc --verbose --version` shows the version of LLVM used by the Rust compiler.)

Make sure you install a de-mangler binary:

```shell
cargo install rustfilt
rustup component add llvm-tools-preview
```

## Build

You can try this out on your code by rebuilding your code with `-Cinstrument-coverage`

```shell
mkdir -p modules/core/target/debug/coverage-testing
RUSTFLAGS="-C instrument-coverage" cargo build --manifest-path modules/core/Cargo.toml
mv modules/core/default.profraw modules/core/target/debug/coverage-testing/
```

## Analyse

The llvm-tools-preview component includes llvm-profdata for processing and merging raw profile output (coverage region execution counts); and llvm-cov for report generation. llvm-cov combines the processed output, from llvm-profdata, and the binary itself, because the binary embeds a mapping from counters to actual source code regions.

### Merge

```shell
~/.rustup/toolchains/stable-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/bin/llvm-profdata \
  merge -sparse modules/core/target/debug/coverage-testing/default.profraw \
  -o modules/core/target/debug/coverage-testing/default.profdata
```

### Show

```shell
~/.rustup/toolchains/stable-aarch64-apple-darwin/lib/rustlib/aarch64-apple-darwin/bin/llvm-cov \
  show -Xdemangler=rustfilt modules/core/target/debug/coverage-testing \
  -instr-profile=modules/core/target/debug/coverage-testing/default.profdata \
  -show-line-counts-or-regions \
  -show-instantiations
```

The above commands on a simple helloworld binary produce this annotated report, showing that each line of the input was covered.

For more details, please read the [documentation](https://doc.rust-lang.org/rustc/instrument-coverage.html) in the rustc book.
